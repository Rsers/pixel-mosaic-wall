# Vercel 部署实践与经验总结

**日期：** 2025-10-15  
**主题：** Vercel 无服务器部署实践  
**关键词：** vercel, serverless, deployment, file-upload, architecture  
**状态：** 已完成

## 核心内容

今天成功将 Pixel Mosaic Wall 项目部署到 Vercel 平台，期间遇到了文件上传 500 错误和 Flask import 语句缺失等关键问题。通过创建 API 路由适配 /tmp 目录限制，并修复代码导入问题，最终实现了稳定部署。这次实践让我深入理解了 Vercel 无服务器架构的特点和限制，为未来项目部署积累了宝贵经验。

## 背景

选择 Vercel 进行部署实践主要基于几个考虑：首先，虽然已有闲置服务器用于开发，但希望体验 Vercel 的自动部署流程和全球 CDN 加速优势；其次，无服务器架构是当前云原生发展的重要方向，需要深入了解其实际应用场景；最后，不同部署环境的适配能力是现代开发者的必备技能，这次实践提供了很好的学习机会。

## 关键问题与解决方案

### 问题1：文件上传 500 错误

在初始部署后，文件上传功能出现 500 内部服务器错误。经过排查发现，Vercel 的文件系统是只读的，传统的静态文件服务无法访问 /tmp 目录。解决方案是创建专门的 API 路由 `/uploads/<template>/<filename>` 来动态提供上传的文件，绕过了静态文件服务的限制。

### 问题2：Flask import 缺失导致部署崩溃

部署过程中遇到紧急崩溃问题，原因是 AI 生成代码时省略了关键的 Flask import 语句。通过添加完整的导入语句 `from flask import Flask, request, jsonify, render_template, send_file` 解决了问题。这个教训提醒我们，AI 生成的代码必须经过严格审核，特别是基础导入语句。

### 问题3：Vercel 配置警告

初始配置使用了已过时的 `builds` 配置方式，Vercel 提示迁移警告。通过研究官方文档，将配置更新为推荐的 `rewrites` 方式，不仅消除了警告，还优化了路由处理逻辑。

## 技术方案

### 环境适配策略

为了实现本地和 Vercel 环境的无缝切换，采用了环境判断策略。使用 `os.environ.get("VERCEL")` 检测运行环境，在 Vercel 环境下使用 `/tmp/uploads/` 存储文件和 `/tmp/pixels.db` 作为数据库，而在本地环境则使用传统的 `static/uploads/` 和 `pixels.db`。

### 文件访问路由

针对不同环境的文件访问需求，设计了双重访问机制。本地开发时依赖 Nginx 提供静态文件服务，而在 Vercel 环境下则通过 Flask API 路由动态提供文件访问。同时实现了路径穿越防护和文件名白名单验证，确保系统安全性。

### 自动化测试脚本

为避免类似 import 缺失的问题再次发生，创建了 `scripts/test-before-deploy.sh` 自动化测试脚本。该脚本包含 Python 语法检查、模块导入测试、import 语句验证等功能，确保代码质量后再进行部署。

## 经验总结

### Vercel 的优势

Vercel 展现了无服务器平台的显著优势：自动部署功能实现了 Git 推送即部署的流畅体验；全球 CDN 让应用自动获得全球加速和 HTTPS 支持；多项目支持允许一个账号部署多个独立应用；零配置特性自动检测框架和依赖，大幅简化部署流程。

### Vercel 的限制

同时，Vercel 也存在一些重要限制：文件系统只读特性限制了本地文件存储能力；/tmp 目录的临时性意味着重新部署会清空所有上传文件；函数执行时间限制在免费版最多 10 秒；WebSocket 支持有限，不适合需要长连接的实时应用。

### 适用场景分析

基于实践体验，Vercel 特别适合无状态 API、静态网站配合简单后端、以及使用外部存储的应用。然而，对于需要大量文件上传、长时间运行任务或实时 WebSocket 通信的应用，传统服务器方案可能更为合适。

### 开发策略建议

混合开发策略被证明是最优选择：80% 时间在本地或自有服务器进行快速开发，享受即时反馈和无限制环境；10% 时间用于本地测试 Vercel 兼容性，验证环境判断代码；最后 10% 时间推送到 Vercel 进行实际验证。发现问题时及时回到本地环境修复，形成高效迭代循环。

### 成本优化

在问题解决过程中，使用 DeepSeek Reasoner 生成适配代码仅花费 ¥0.05，相比 Cursor 直接修改的 ¥0.30 成本，节省了 83%。这体现了合理选择 AI 工具在开发效率和经济性方面的重要性。

### 关键教训

这次实践提供了几个重要教训：AI 生成代码必须经过人工审核，特别是基础导入语句；部署前的本地测试不可或缺，应该建立标准化测试流程；环境差异需要提前考虑，通过环境判断代码实现兼容；/tmp 目录的临时性决定了生产环境需要外部存储方案。

## 生产环境方案（未来）

如果要将应用真正投入生产环境，需要引入外部服务：使用 Cloudflare R2 存储图片文件，享受免费 10GB 存储空间；采用 Supabase 作为数据库解决方案，提供免费 500MB 存储容量。这种组合方案可以实现完全免费的数据永久保存，同时保持应用的性能表现。

## 下一步

完成本次部署实践后，下一步计划包括：验证 Vercel 部署的稳定性，全面测试文件上传功能性能，评估是否真正需要迁移到外部存储方案，以及文档化从开发到部署的完整流程，为团队协作和未来项目提供参考。

## 参考文档

- docs/FIX-VERCEL-FILE-UPLOAD-20251015.md
- docs/VERCEL-CONFIG-OPTIMIZATION.md
- docs/HOTFIX-MISSING-IMPORT-20251015.md
- scripts/test-before-deploy.sh
